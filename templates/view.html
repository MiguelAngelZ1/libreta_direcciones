{% extends "base.html" %}
{% block title %}Ver Contactos - Mi Aplicación{% endblock %}

{% block content %}
<div class="container mt-5">
  <!-- Fila con el Título y el botón "Volver al Inicio" -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-6">
      <h1 class="mb-0">Lista de Contactos</h1>
    </div>
    <div class="col-md-6 text-end">
      <a href="{{ url_for('index') }}" class="btn btn-success">
        <i class="fas fa-home"></i> Volver al Inicio
      </a>
    </div>
  </div>
  
  <!-- Buscador en tiempo real -->
  <div class="row mb-4">
    <div class="col">
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre o apellido...">
    </div>
  </div>
  
  <!-- Bloque para mostrar mensajes flash -->
  <div class="mb-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>
  
  <!-- Tabla de contactos -->
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Grado</th>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>DNI</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="contactoTable">
      {% for c in registros %}
      <tr>
        <td>{{ c.grado }}</td>
        <td>{{ c.nombre }}</td>
        <td>{{ c.apellido }}</td>
        <td>{{ c.dni }}</td>
        <td>
          <!-- Botón de Editar: abre el modal -->
          <button type="button" class="btn btn-primary btn-sm" title="Editar" 
                  onclick="openEditModal('{{ c.id }}', '{{ c.grado }}', '{{ c.nombre }}', '{{ c.apellido }}', '{{ c.dni }}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <!-- Botón de Eliminar -->
          <form method="post" action="{{ url_for('delete') }}" style="display:inline;" 
                onsubmit="return confirm('¿Seguro que deseas eliminar este contacto?');">
            <input type="hidden" name="id" value="{{ c.id }}">
            <button type="submit" class="btn btn-danger btn-sm" title="Eliminar">
              <i class="fas fa-trash-alt"></i> Eliminar
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal para editar contacto -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Editar Contacto</h5>
      <button type="button" class="close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editForm" method="post" action="{{ url_for('edit') }}">
        <input type="hidden" name="id" id="edit-id">
        <div class="mb-3">
          <label for="edit-grado" class="form-label">Grado:</label>
          <input type="text" name="grado" id="edit-grado" class="form-control">
        </div>
        <div class="mb-3">
          <label for="edit-nombre" class="form-label">Nombre:</label>
          <input type="text" name="nombre" id="edit-nombre" class="form-control">
        </div>
        <div class="mb-3">
          <label for="edit-apellido" class="form-label">Apellido:</label>
          <input type="text" name="apellido" id="edit-apellido" class="form-control">
        </div>
        <div class="mb-3">
          <label for="edit-dni" class="form-label">DNI:</label>
          <input type="text" name="dni" id="edit-dni" class="form-control">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary close-btn" onclick="closeEditModal()">Cancelar</button>
      <button type="submit" form="editForm" class="btn btn-success">
        <i class="fas fa-check"></i> Confirmar Cambios
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Abre el modal y precarga los datos del contacto
function openEditModal(id, grado, nombre, apellido, dni) {
  document.getElementById("edit-id").value = id;
  document.getElementById("edit-grado").value = grado;
  document.getElementById("edit-nombre").value = nombre;
  document.getElementById("edit-apellido").value = apellido;
  document.getElementById("edit-dni").value = dni;
  document.getElementById("editModal").style.display = "block";
}

// Cierra el modal
function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

// Cierra el modal si el usuario hace clic fuera de él
window.onclick = function(event) {
  var modal = document.getElementById("editModal");
  if (event.target == modal) {
    closeEditModal();
  }
};

// Búsqueda en tiempo real
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.addEventListener("input", function(){
      let q = searchInput.value;
      fetch(`/search?q=${encodeURIComponent(q)}`)
        .then(response => response.json())
        .then(data => {
          let tbody = document.getElementById("contactoTable");
          tbody.innerHTML = "";
          data.forEach(function(contacto) {
            let tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${contacto.grado}</td>
              <td>${contacto.nombre}</td>
              <td>${contacto.apellido}</td>
              <td>${contacto.dni}</td>
              <td>
                <button type="button" class="btn btn-primary btn-sm" title="Editar" onclick="openEditModal('${contacto.id}', '${contacto.grado}', '${contacto.nombre}', '${contacto.apellido}', '${contacto.dni}')">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <form method="post" action="{{ url_for('delete') }}" style="display:inline;" onsubmit="return confirm('¿Seguro que deseas eliminar este contacto?');">
                  <input type="hidden" name="id" value="${contacto.id}">
                  <button type="submit" class="btn btn-danger btn-sm" title="Eliminar">
                    <i class="fas fa-trash-alt"></i> Eliminar
                  </button>
                </form>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(error => console.error("Error en la búsqueda en tiempo real", error));
    });
  }
});
</script>
{% endblock %}
